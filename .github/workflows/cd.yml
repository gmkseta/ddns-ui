name: Continuous Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  release:
    types: [ published ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: gmkseta/ddns-ui

jobs:
  build-and-push:
    name: ğŸš€ Build & Push to Docker Hub
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}
        flavor: |
          latest=auto
          
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“ Generate release notes
      if: github.event_name == 'release'
      id: release_notes
      run: |
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸš€ ìƒˆ ë²„ì „ ë¦´ë¦¬ìŠ¤: ${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“¦ Docker ì´ë¯¸ì§€" >> $GITHUB_OUTPUT
        echo '```bash' >> $GITHUB_OUTPUT
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ”— ë¹ ë¥¸ ì‹¤í–‰" >> $GITHUB_OUTPUT
        echo '```bash' >> $GITHUB_OUTPUT
        echo "docker run -d \\" >> $GITHUB_OUTPUT
        echo "  --name ddns-ui \\" >> $GITHUB_OUTPUT
        echo "  -p 3000:3000 \\" >> $GITHUB_OUTPUT
        echo "  -v ddns-data:/app/data \\" >> $GITHUB_OUTPUT
        echo "  -e ADMIN_USERNAME=admin \\" >> $GITHUB_OUTPUT
        echo "  -e ADMIN_PASSWORD=your-password \\" >> $GITHUB_OUTPUT
        echo "  -e JWT_SECRET=your-jwt-secret \\" >> $GITHUB_OUTPUT
        echo "  --restart unless-stopped \\" >> $GITHUB_OUTPUT
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“‹ ì£¼ìš” ë³€ê²½ì‚¬í•­" >> $GITHUB_OUTPUT
        echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  security-scan:
    name: ğŸ”’ Security Scan Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: success()
    
    steps:
    - name: ğŸ‰ Send Slack success notification
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        IMAGE_TAG=${{ github.ref == 'refs/heads/main' && 'latest' || github.ref_name }}
        BRANCH_NAME=${{ github.ref_name }}
        
        curl -X POST "$SLACK_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d '{
          "text": "ğŸš€ DDNS-UI ë°°í¬ ì„±ê³µ!",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸš€ Docker Hub ë°°í¬ ì™„ë£Œ!"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*ì´ë¯¸ì§€:*\n`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:'"${IMAGE_TAG}"'`"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ì»¤ë°‹:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|'"${SHA}"'>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ë¸Œëœì¹˜:*\n'"${BRANCH_NAME}"'"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ë°°í¬ ì‹œê°„:*\n'"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ³ Docker ì‹¤í–‰:*\n```docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:'"${IMAGE_TAG}"'```"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸŒ ë‹¤êµ­ì–´ ì§€ì›:*\nâ€¢ ğŸ‡°ğŸ‡· í•œêµ­ì–´: `http://localhost:3000/ko`\nâ€¢ ğŸ‡ºğŸ‡¸ ì˜ì–´: `http://localhost:3000/en`\nâ€¢ ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: `http://localhost:3000/ja`"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "Docker Hub"
                  },
                  "url": "https://hub.docker.com/r/${{ env.IMAGE_NAME }}"
                },
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ì»¤ë°‹ ë³´ê¸°"
                  },
                  "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                }
              ]
            }
          ]
        }'

  notify-failure:
    name: ğŸ“¢ Notify Failure
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: failure()
    
    steps:
    - name: âŒ Send Slack failure notification
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        BRANCH_NAME=${{ github.ref_name }}
        
        curl -X POST "$SLACK_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d '{
          "text": "âŒ DDNS-UI ë°°í¬ ì‹¤íŒ¨!",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "âŒ Docker Hub ë°°í¬ ì‹¤íŒ¨!"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*ì»¤ë°‹:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|'"${SHA}"'>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ë¸Œëœì¹˜:*\n'"${BRANCH_NAME}"'"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ì‹¤íŒ¨ ì‹œê°„:*\n'"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ì›Œí¬í”Œë¡œìš°:*\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ› ï¸ í•´ê²° ë°©ë²•:*\n1. GitHub Actions ë¡œê·¸ í™•ì¸\n2. Docker Hub ìê²© ì¦ëª… í™•ì¸\n3. ë¹Œë“œ ì—ëŸ¬ ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œ"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ”§ ë””ë²„ê¹… íŒ:*\nâ€¢ ESLint ì˜¤ë¥˜: `yarn lint --fix`\nâ€¢ íƒ€ì… ì—ëŸ¬: `yarn type-check`\nâ€¢ ë¹Œë“œ ì—ëŸ¬: `yarn build`\nâ€¢ Docker ë¹Œë“œ: `docker build -t test .`"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ì›Œí¬í”Œë¡œìš° ë¡œê·¸"
                  },
                  "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "style": "danger"
                }
              ]
            }
          ]
        }' 