name: Continuous Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  release:
    types: [ published ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: gmkseta/ddns-ui

jobs:
  build-and-push:
    name: ğŸš€ Build & Push to Docker Hub
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}
        flavor: |
          latest=auto
          
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“ Generate release notes
      if: github.event_name == 'release'
      id: release_notes
      run: |
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸš€ ìƒˆ ë²„ì „ ë¦´ë¦¬ìŠ¤: ${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“¦ Docker ì´ë¯¸ì§€" >> $GITHUB_OUTPUT
        echo '```bash' >> $GITHUB_OUTPUT
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ”— ë¹ ë¥¸ ì‹¤í–‰" >> $GITHUB_OUTPUT
        echo '```bash' >> $GITHUB_OUTPUT
        echo "docker run -d \\" >> $GITHUB_OUTPUT
        echo "  --name ddns-ui \\" >> $GITHUB_OUTPUT
        echo "  -p 3000:3000 \\" >> $GITHUB_OUTPUT
        echo "  -v ddns-data:/app/data \\" >> $GITHUB_OUTPUT
        echo "  -e ADMIN_USERNAME=admin \\" >> $GITHUB_OUTPUT
        echo "  -e ADMIN_PASSWORD=your-password \\" >> $GITHUB_OUTPUT
        echo "  -e JWT_SECRET=your-jwt-secret \\" >> $GITHUB_OUTPUT
        echo "  --restart unless-stopped \\" >> $GITHUB_OUTPUT
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“‹ ì£¼ìš” ë³€ê²½ì‚¬í•­" >> $GITHUB_OUTPUT
        echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  security-scan:
    name: ğŸ”’ Security Scan Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: success()
    
    steps:
    - name: ğŸ‰ Create success issue comment
      uses: actions/github-script@v7
      with:
        script: |
          const sha = context.sha.substring(0, 7);
          const imageTag = context.ref === 'refs/heads/main' ? 'latest' : context.ref.replace('refs/tags/', '');
          
          // Create a new issue for deployment notification
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš€ ë°°í¬ ì™„ë£Œ: ${imageTag} (${sha})`,
            body: `## ğŸ‰ Docker Hub ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            ### ğŸ“¦ ë°°í¬ ì •ë³´
            - **ì´ë¯¸ì§€**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${imageTag}\`
            - **ì»¤ë°‹**: \`${sha}\`
            - **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`
            - **ë°°í¬ ì‹œê°„**: \`${new Date().toISOString()}\`
            
            ### ğŸ³ ì‚¬ìš© ë°©ë²•
            \`\`\`bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${imageTag}
            \`\`\`
            
            ### ğŸŒ ë‹¤êµ­ì–´ ì§€ì›
            - ğŸ‡°ğŸ‡· í•œêµ­ì–´ (ê¸°ë³¸): \`http://localhost:3000/ko\`
            - ğŸ‡ºğŸ‡¸ ì˜ì–´: \`http://localhost:3000/en\`
            - ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: \`http://localhost:3000/ja\`
            
            ### ğŸ”— ë§í¬
            - [Docker Hub](https://hub.docker.com/r/${{ env.IMAGE_NAME }})
            - [ì»¤ë°‹ ìƒì„¸](https://github.com/${{ github.repository }}/commit/${context.sha})
            
            ---
            ğŸ¤– *ìë™ ë°°í¬ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë¨*`,
            labels: ['deployment', 'docker', 'success']
          });
          
          // Auto-close the issue after 1 day (for cleanup)
          setTimeout(async () => {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
          }, 24 * 60 * 60 * 1000);

  notify-failure:
    name: ğŸ“¢ Notify Failure
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: failure()
    
    steps:
    - name: âŒ Create failure issue
      uses: actions/github-script@v7
      with:
        script: |
          const sha = context.sha.substring(0, 7);
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `âŒ ë°°í¬ ì‹¤íŒ¨: ${context.ref.replace('refs/heads/', '')} (${sha})`,
            body: `## âŒ Docker Hub ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!
            
            ### ğŸ” ì‹¤íŒ¨ ì •ë³´
            - **ì»¤ë°‹**: \`${sha}\`
            - **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`
            - **ì‹¤íŒ¨ ì‹œê°„**: \`${new Date().toISOString()}\`
            - **ì›Œí¬í”Œë¡œìš°**: [í™•ì¸í•˜ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ› ï¸ í•´ê²° ë°©ë²•
            1. [GitHub Actions ë¡œê·¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) í™•ì¸
            2. Docker Hub ìê²© ì¦ëª… í™•ì¸
            3. ë¹Œë“œ ì—ëŸ¬ ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œ
            
            ### ğŸ”§ ë””ë²„ê¹… íŒ
            - ESLint ì˜¤ë¥˜: \`yarn lint --fix\`
            - íƒ€ì… ì—ëŸ¬: \`yarn type-check\`
            - ë¹Œë“œ ì—ëŸ¬: \`yarn build\`
            - Docker ë¹Œë“œ: \`docker build -t test .\`
            
            ---
            ğŸ¤– *ìë™ ë°°í¬ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë¨*`,
            labels: ['deployment', 'docker', 'failure', 'bug']
          }); 