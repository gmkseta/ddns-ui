name: Continuous Integration

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  lint-and-typecheck:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: ğŸ“¦ Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: ğŸ” Run ESLint
      run: yarn lint --max-warnings 0
      continue-on-error: false
      
    - name: ğŸ·ï¸ Run TypeScript type check
      run: yarn type-check
      continue-on-error: false

  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: ğŸ“¦ Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: ğŸ—ï¸ Build application
      run: yarn build
      env:
        DATABASE_PATH: './data/db.sqlite3'
        JWT_SECRET: 'test-jwt-secret-for-build'
        ADMIN_USERNAME: 'admin'
        ADMIN_PASSWORD: 'test'

  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: ddns-ui:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: ğŸ“¦ Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: ğŸ”’ Run security audit
      run: yarn audit --level moderate
      continue-on-error: true
      
    - name: ğŸ” Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript,typescript
        
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  dependency-review:
    name: ğŸ“‹ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ“‹ Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate

  pr-labeler:
    name: ğŸ·ï¸ Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ·ï¸ Label PR
      uses: actions/labeler@v5
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"

  comment-pr:
    name: ğŸ’¬ Comment on PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    needs: [lint-and-typecheck, build-test, docker-build-test]
    
    permissions:
      pull-requests: write
      
    steps:
    - name: ğŸ’¬ Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ PR ìë™ ê²€ì‚¬ ì™„ë£Œ!
            
            âœ… **ëª¨ë“  ê²€ì‚¬ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!**
            
            ### ğŸ“‹ ê²€ì‚¬ í•­ëª©
            - ğŸ” **ë¦°íŠ¸ ê²€ì‚¬**: ESLint ê·œì¹™ ì¤€ìˆ˜
            - ğŸ·ï¸ **íƒ€ì… ê²€ì‚¬**: TypeScript íƒ€ì… ì•ˆì „ì„±
            - ğŸ—ï¸ **ë¹Œë“œ í…ŒìŠ¤íŠ¸**: í”„ë¡œë•ì…˜ ë¹Œë“œ ì„±ê³µ
            - ğŸ³ **Docker ë¹Œë“œ**: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ
            - ğŸ”’ **ë³´ì•ˆ ê²€ì‚¬**: ì·¨ì•½ì  ë° ì˜ì¡´ì„± ê²€í† 
            
            ### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„
            - ì½”ë“œ ë¦¬ë·° í›„ **main** ë¸Œëœì¹˜ì— ë¨¸ì§€í•˜ë©´ ìë™ìœ¼ë¡œ Docker Hubì— ë°°í¬ë©ë‹ˆë‹¤
            - ë¨¸ì§€ ì „ì— ëª¨ë“  CI ê²€ì‚¬ê°€ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤
            
            ---
            ğŸ¤– *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤*`
          }) 